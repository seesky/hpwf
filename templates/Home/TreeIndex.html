<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=EmulateIE9" />
        <title>Python快速开发框架</title>
        <link href="/Content/Images/favicon.ico" rel="shortcut icon" type="image/x-icon" />
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/layui@2.8.18/dist/css/layui.css" />
        <link href="/Content/Scripts/showloading/showLoading.css" rel="stylesheet" type="text/css" />
        <link href="/Content/Styles/common.css" rel="stylesheet" type="text/css" />
        <link href="/Content/Styles/iconNew16.css" rel="stylesheet" type="text/css" />
        <style>
            body,
            html {
                height: 100%;
                background-color: #f5f7fb;
            }

            .admin-shell {
                min-height: 100vh;
                display: flex;
                flex-direction: column;
            }

            .header-bar {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 0 24px;
                background: linear-gradient(90deg, #1a1c2d 0%, #2f365f 100%);
                color: #fff;
            }

            .header-bar .logo {
                font-size: 20px;
                font-weight: 600;
                letter-spacing: 1px;
            }

            .header-bar .user-meta {
                display: flex;
                align-items: center;
                gap: 12px;
            }

            .header-bar .user-meta .welcome {
                display: inline-flex;
                align-items: center;
                gap: 6px;
                font-size: 14px;
            }

            .header-bar .timer {
                font-size: 13px;
                color: rgba(255, 255, 255, 0.7);
                margin-right: 12px;
            }

            .layout-main {
                flex: 1;
                display: flex;
                min-height: 0;
                --sidebar-width: 260px;
            }

            .layui-side {
                width: var(--sidebar-width);
                background: #ffffff;
                box-shadow: inset -1px 0 0 #edf2f7;
                flex: 0 0 var(--sidebar-width);
                min-width: 200px;
                max-width: 480px;
                transition: width 0.12s ease;
            }

            .layui-side-scroll {
                padding: 20px 16px 24px;
            }

            .tree-panel {
                background: #fff;
                border-radius: 12px;
                box-shadow: 0 10px 24px rgba(15, 18, 47, 0.08);
                padding: 16px 12px;
            }

            .tree-panel .panel-title {
                font-size: 16px;
                font-weight: 600;
                margin-bottom: 12px;
                display: flex;
                align-items: center;
                gap: 8px;
                color: #2d3748;
            }

            .layui-tree-entry .layui-tree-main {
                display: flex;
                align-items: center;
                gap: 8px;
                font-size: 14px;
                padding: 6px 10px;
                border-radius: 6px;
                transition: background 0.2s ease;
            }

            .layui-tree-entry .layui-tree-main:hover {
                background: rgba(30, 144, 255, 0.08);
            }

            .layui-tree-entry i[class^="icon16_"],
            .layui-tree-entry i[class*=" icon16_"] {
                display: inline-block;
                width: 16px;
                height: 16px;
                background-size: contain;
            }

            .sidebar-resizer {
                width: 6px;
                background: linear-gradient(180deg, rgba(47, 54, 95, 0.05) 0%, rgba(47, 54, 95, 0.15) 100%);
                cursor: col-resize;
                position: relative;
                z-index: 12;
            }

            .sidebar-resizer::after {
                content: '';
                position: absolute;
                top: 50%;
                left: 50%;
                width: 2px;
                height: 32px;
                margin: -16px 0 0 -1px;
                border-radius: 2px;
                background: rgba(47, 54, 95, 0.35);
            }

            .resizing,
            .resizing * {
                cursor: col-resize !important;
                user-select: none !important;
            }

            .layui-body {
                background: #f5f7fb;
                padding: 16px;
                overflow: hidden;
                flex: 1;
                min-width: 0;
            }

            .workspace {
                height: 100%;
                background: #fff;
                border-radius: 12px;
                box-shadow: 0 12px 24px rgba(15, 18, 47, 0.08);
                display: flex;
                flex-direction: column;
            }

            .workspace .layui-tab {
                flex: 1;
                display: flex;
                flex-direction: column;
            }

            .workspace .layui-tab-title {
                flex-shrink: 0;
                border-bottom: 1px solid #edf2f7;
            }

            .workspace .layui-tab-content {
                flex: 1;
                padding: 0;
            }

            .workspace .layui-tab-item {
                height: 100%;
                padding: 0;
            }

            .main-iframe {
                width: 100%;
                height: 100%;
            }

            .layui-tab-title li.tab-home .layui-tab-close {
                display: none !important;
            }

            .footer-bar {
                text-align: center;
                font-size: 13px;
                color: #718096;
                background: #fff;
            }

            #closeMenu {
                position: absolute;
                display: none;
                background: #ffffff;
                border-radius: 8px;
                box-shadow: 0 12px 24px rgba(15, 18, 47, 0.12);
                padding: 6px 0;
                z-index: 9999;
                min-width: 160px;
            }

            #closeMenu li {
                list-style: none;
                padding: 8px 20px;
                font-size: 13px;
                cursor: pointer;
                transition: background 0.2s ease;
            }

            #closeMenu li:hover {
                background: rgba(30, 144, 255, 0.12);
            }

            #loading {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: #fff;
                z-index: 1000;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            #loading img {
                width: 48px;
                height: 48px;
            }

            .noscript-warning {
                position: absolute;
                z-index: 100000;
                height: 2046px;
                top: 0;
                left: 0;
                width: 100%;
                background: white;
                text-align: center;
            }
        </style>
    </head>
    <body class="layui-layout-body">
        <div id="loading">
            <img src="/Content/Images/ajax-loader.gif" alt="加载中" />
        </div>

        <noscript>
            <div class="noscript-warning">
                <img src="/Content/Images/noscript.gif" alt='抱歉，请开启脚本支持！' />
            </div>
        </noscript>

        <div class="layui-layout layui-layout-admin admin-shell">
            <div class="layui-header header-bar">
                <div class="logo">Python快速开发框架</div>
                <div class="user-meta">
                    <div class="timer" id="timerSpan"></div>
                    <span class="welcome">
                        <i class="icon16_administrator"></i>
                        欢迎 <b id="curname">{{ Account }}</b>
                    </span>
                    <button id="editPass" type="button" class="layui-btn layui-btn-primary layui-btn-sm">
                        <i class="layui-icon layui-icon-password"></i>
                        修改密码
                    </button>
                    <button id="loginOut" type="button" class="layui-btn layui-btn-danger layui-btn-sm">
                        <i class="layui-icon layui-icon-logout"></i>
                        退出系统
                    </button>
                </div>
            </div>

            <div class="layout-main">
                <div class="layui-side">
                    <div class="layui-side-scroll">
                        <div class="tree-panel">
                            <div class="panel-title">
                                <i class="layui-icon layui-icon-template-1"></i>
                                导航菜单
                            </div>
                            <div id="menuTree" class="layui-tree"></div>
                        </div>
                    </div>
                </div>

                <div class="sidebar-resizer" id="sidebarResizer"></div>

                <div class="layui-body">
                    <div class="workspace">
                        <div class="layui-tab layui-tab-card" lay-filter="mainTabs" lay-allowclose="true" id="mainTabs"></div>
                    </div>
                </div>
            </div>

            <div class="layui-footer footer-bar">
                Copyright &copy; hpwf, All Rights Reserved
            </div>
        </div>

        <ul id="closeMenu">
            <li data-action="refresh">刷新</li>
            <li data-action="close">关闭</li>
            <li data-action="closeall">全部关闭</li>
            <li data-action="closeother">除此之外全部关闭</li>
            <li data-action="closeright">关闭右侧窗口</li>
            <li data-action="closeleft">关闭左侧窗口</li>
            <li data-action="exit">退出</li>
        </ul>

        <div id="loading_background" class="loading_background" style="display: none;"></div>
        <div id="loadingGird" class="loading_background" style="display: none;"></div>

        <script type="text/javascript" src="/Content/Scripts/jquery-1.8.3.min.js"></script>
        <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/layui@2.8.18/dist/layui.js"></script>
        <script type="text/javascript" src="/Content/Scripts/jQuery.Ajax.js"></script>
        <script type="text/javascript" src="/Content/Scripts/hpwf-core.js"></script>
        <script type="text/javascript" src="/Content/Scripts/jsCommon.js?v=30"></script>
        <script type="text/javascript" src="/Content/Scripts/jQuery.cookie.js"></script>
        <script type="text/javascript" src="/Content/Scripts/csrf.js"></script>
        <script type="text/javascript" src="/Content/Scripts/clearcookie.js"></script>
        <script type="text/javascript" src="/Content/Scripts/qqmsg/jQuery.qqmsg.js"></script>
        <script type="text/javascript" src="/Content/Scripts/showloading/jquery.showLoading.min.js"></script>
        <script type="text/javascript" src="/Content/Scripts/hpwf-admin-layui.js"></script>
        <script>
            layui.use(['element', 'layer', 'tree', 'form', 'util'], function () {
                var element = layui.element;
                var layer = layui.layer;
                var tree = layui.tree;
                var form = layui.form;
                var util = layui.util;
                var $ = layui.$;
                var errorUrl = '/error/error404';

                HPWFIndex.init({
                    element: element,
                    layer: layer,
                    form: form,
                    util: util,
                    $: $,
                    homeUrl: '/Admin/StartPage'
                });

                function escapeHtml(text) {
                    return String(text || '')
                        .replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                        .replace(/"/g, '&quot;')
                        .replace(/'/g, '&#39;');
                }

                function buildTree(nodes) {
                    return $.map(nodes || [], function (item) {
                        var iconCls = item.iconCls || 'layui-icon layui-icon-file-b';
                        var url = (item.attributes && item.attributes.url) ? item.attributes.url : '';
                        return {
                            id: item.id,
                            title: '<span class="menu-node"><i class="' + iconCls + '"></i><cite>' + escapeHtml(item.text) + '</cite></span>',
                            titleText: item.text,
                            href: url,
                            iconCls: iconCls,
                            spread: item.state === 'open',
                            children: buildTree(item.children)
                        };
                    });
                }

                function renderTree(data) {
                    tree.render({
                        elem: '#menuTree',
                        data: buildTree(data),
                        showLine: true,
                        onlyIconControl: true,
                        click: function (obj) {
                            var node = obj.data;
                            if (node.href && node.href !== '#') {
                                HPWFIndex.addTab(node.titleText, node.href, node.iconCls);
                            } else if (node.href !== '#') {
                                HPWFIndex.addTab(node.titleText, errorUrl, node.iconCls);
                            }
                        }
                    });
                }

                function loadMenu() {
                    $.ajaxjson('/Admin/LoadTreeMenu/', { csrfmiddlewaretoken: '{{ csrf_token }}' }, function (data) {
                        renderTree(data);
                    });
                }

                loadMenu();

                function initSidebarResize() {
                    var $layout = $('.layout-main');
                    var $sidebar = $layout.find('.layui-side');
                    var $resizer = $('#sidebarResizer');
                    var layoutEl = $layout.get(0);
                    var minWidth = 200;
                    var maxWidth = 480;
                    var startX = 0;
                    var startWidth = 0;

                    function getSidebarWidth() {
                        if (layoutEl) {
                            var computed = window.getComputedStyle(layoutEl).getPropertyValue('--sidebar-width');
                            var parsed = parseInt(computed, 10);
                            if (!isNaN(parsed)) {
                                return parsed;
                            }
                        }
                        return $sidebar.outerWidth() || 260;
                    }

                    function setSidebarWidth(width) {
                        width = Math.max(minWidth, Math.min(maxWidth, width));
                        if (layoutEl) {
                            layoutEl.style.setProperty('--sidebar-width', width + 'px');
                        }
                        $sidebar.css('width', width + 'px');
                    }

                    setSidebarWidth(getSidebarWidth());

                    $resizer.on('mousedown', function (e) {
                        startX = e.clientX;
                        startWidth = $sidebar.outerWidth();
                        $('body').addClass('resizing');

                        $(document)
                            .on('mousemove.sidebarResize', function (event) {
                                var newWidth = startWidth + (event.clientX - startX);
                                setSidebarWidth(newWidth);
                            })
                            .on('mouseup.sidebarResize', function () {
                                $('body').removeClass('resizing');
                                $(document).off('.sidebarResize');
                            });

                        e.preventDefault();
                    });
                }

                initSidebarResize();

                function updateTimer() {
                    var now = new Date();
                    $('#timerSpan').text(util.toDateString(now, 'yyyy-MM-dd HH:mm:ss'));
                }

                updateTimer();
                setInterval(updateTimer, 1000);

                var lastTime = new Date().getTime();
                var timeOut = 30 * 60 * 1000;

                $(document).on('mousemove keydown click', function () {
                    lastTime = new Date().getTime();
                });

                setInterval(function () {
                    var currentTime = new Date().getTime();
                    if (currentTime - lastTime > timeOut) {
                        clearCookie();
                        window.location.href = '/Admin/Index/';
                    }
                }, 10000);
            });
        </script>
    </body>
</html>
