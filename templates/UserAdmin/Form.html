<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8" />
    <title>用户信息</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/layui@2.8.18/dist/css/layui.css" integrity="sha384-6DCQE4kq1XEy+8GJtI75G2uHzoFgsxH8KHCBGbQSDxWoW8WgknOcZ5IRCDYXMVZX" crossorigin="anonymous" />
    <style>
        body {
            padding: 16px;
            background-color: #f5f5f5;
        }

        .user-form-card {
            max-width: 720px;
            margin: 0 auto;
        }

        .user-form-card .layui-card-body {
            padding: 20px 24px 30px;
        }

        .layui-form-item .layui-inline {
            width: 48%;
        }

        .layui-form-label {
            width: 110px;
        }

        .layui-input-block {
            margin-left: 140px;
        }

        @media (max-width: 768px) {
            .layui-form-item .layui-inline {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="layui-card user-form-card">
        <div class="layui-card-header">用户信息</div>
        <div class="layui-card-body">
            <form class="layui-form" lay-filter="userForm" id="userForm">
                <div class="layui-form-item">
                    <div class="layui-inline">
                        <label class="layui-form-label">登录用户名</label>
                        <div class="layui-input-block">
                            <input type="text" name="username" id="username" lay-verify="required|len40" autocomplete="off" placeholder="请输入登录用户名" class="layui-input" />
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">姓名</label>
                        <div class="layui-input-block">
                            <input type="text" name="realname" id="realname" lay-verify="required|len40" autocomplete="off" placeholder="请输入姓名" class="layui-input" />
                        </div>
                    </div>
                </div>

                <div class="layui-form-item">
                    <div class="layui-inline">
                        <label class="layui-form-label">编号</label>
                        <div class="layui-input-block">
                            <input type="text" name="code" id="code" lay-verify="required|len40" autocomplete="off" placeholder="请输入编号" class="layui-input" />
                        </div>
                    </div>
                    <div class="layui-inline" id="passwordRow">
                        <label class="layui-form-label">用户密码</label>
                        <div class="layui-input-block">
                            <input type="password" name="userpassword" id="userpassword" lay-verify="pass" autocomplete="off" placeholder="请输入密码" class="layui-input" />
                        </div>
                    </div>
                </div>

                <div class="layui-form-item">
                    <div class="layui-inline">
                        <label class="layui-form-label">性别</label>
                        <div class="layui-input-block">
                            <select name="gender" id="gender" lay-verify="required">
                                <option value="">请选择</option>
                            </select>
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">手机号码</label>
                        <div class="layui-input-block">
                            <input type="text" name="mobile" id="mobile" autocomplete="off" placeholder="请输入手机号码" class="layui-input" />
                        </div>
                    </div>
                </div>

                <div class="layui-form-item">
                    <div class="layui-inline">
                        <label class="layui-form-label">出生日期</label>
                        <div class="layui-input-block">
                            <input type="text" name="birthday" id="birthday" placeholder="请选择出生日期" autocomplete="off" class="layui-input" />
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">固定电话</label>
                        <div class="layui-input-block">
                            <input type="text" name="telephone" id="telephone" autocomplete="off" placeholder="请输入固定电话" class="layui-input" />
                        </div>
                    </div>
                </div>

                <div class="layui-form-item">
                    <div class="layui-inline">
                        <label class="layui-form-label">岗位</label>
                        <div class="layui-input-block">
                            <input type="text" name="duty" id="duty" autocomplete="off" placeholder="请输入岗位" class="layui-input" />
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">QQ号码</label>
                        <div class="layui-input-block">
                            <input type="text" name="qicq" id="qicq" autocomplete="off" placeholder="请输入QQ号码" class="layui-input" />
                        </div>
                    </div>
                </div>

                <div class="layui-form-item">
                    <div class="layui-inline">
                        <label class="layui-form-label">职称</label>
                        <div class="layui-input-block">
                            <input type="text" name="title" id="title" autocomplete="off" placeholder="请输入职称" class="layui-input" />
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">邮箱地址</label>
                        <div class="layui-input-block">
                            <input type="text" name="email" id="email" autocomplete="off" placeholder="请输入邮箱地址" class="layui-input" />
                        </div>
                    </div>
                </div>

                <div class="layui-form-item">
                    <label class="layui-form-label">默认角色</label>
                    <div class="layui-input-block">
                        <select name="roleid" id="roleid" lay-verify="required">
                            <option value="">请选择角色</option>
                        </select>
                    </div>
                </div>

                <div class="layui-form-item">
                    <label class="layui-form-label">家庭地址</label>
                    <div class="layui-input-block">
                        <input type="text" name="homeaddress" id="homeaddress" autocomplete="off" placeholder="请输入家庭地址" class="layui-input" />
                    </div>
                </div>

                <div class="layui-form-item">
                    <label class="layui-form-label">所在公司/单位</label>
                    <div class="layui-input-block">
                        <select name="companyid" id="companyid">
                            <option value="">请选择公司/单位</option>
                        </select>
                    </div>
                </div>

                <div class="layui-form-item">
                    <label class="layui-form-label">所在子公司</label>
                    <div class="layui-input-block">
                        <select name="subcompanyid" id="subcompanyid">
                            <option value="">请选择子公司</option>
                        </select>
                    </div>
                </div>

                <div class="layui-form-item">
                    <label class="layui-form-label">所在部门</label>
                    <div class="layui-input-block">
                        <select name="departmentid" id="departmentid">
                            <option value="">请选择部门</option>
                        </select>
                    </div>
                </div>

                <div class="layui-form-item">
                    <label class="layui-form-label">所在子部门</label>
                    <div class="layui-input-block">
                        <select name="subdepartmentid" id="subdepartmentid">
                            <option value="">请选择子部门</option>
                        </select>
                    </div>
                </div>

                <div class="layui-form-item">
                    <label class="layui-form-label">所在工作组</label>
                    <div class="layui-input-block">
                        <select name="workgroupid" id="workgroupid">
                            <option value="">请选择工作组</option>
                        </select>
                    </div>
                </div>

                <div class="layui-form-item">
                    <div class="layui-inline">
                        <label class="layui-form-label">有效性</label>
                        <div class="layui-input-block">
                            <input type="checkbox" name="enabled" id="enabled" lay-skin="switch" lay-text="有效|禁用" checked />
                        </div>
                    </div>
                </div>

                <div class="layui-form-item layui-form-text">
                    <label class="layui-form-label">描述</label>
                    <div class="layui-input-block">
                        <textarea name="description" id="description" placeholder="请输入描述" class="layui-textarea"></textarea>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/layui@2.8.18/dist/layui.js" integrity="sha384-yK65FM0tElXkJuQJxyPny5n0xcgOjsLxU5C04h74hFSe48XLyAuz7wch4+CQ8yJn" crossorigin="anonymous"></script>
    <script src="/Content/Scripts/jquery-1.12.1.min.js"></script>
    <script src="/Content/Scripts/jQuery.Ajax.js"></script>
    <script src="/Content/Scripts/csrf.js"></script>
    <script>
        layui.use(['form', 'laydate', 'layer'], function () {
            var form = layui.form;
            var laydate = layui.laydate;
            var layer = layui.layer;
            var $ = layui.$;

            laydate.render({
                elem: '#birthday',
                trigger: 'click',
                type: 'date'
            });

            form.verify({
                len40: function (value) {
                    if (value && (value.length < 2 || value.length > 40)) {
                        return '请输入2-40个字符';
                    }
                },
                pass: function (value, item) {
                    if ($('#passwordRow').is(':visible') && (!value || value.length < 6)) {
                        return '请输入至少6位的密码';
                    }
                }
            });

            var selectConfigs = [
                { id: 'gender', url: '/Admin/FrameworkModules/Utility/GetCategory?categoryCode=Gender', valueField: 'itemvalue', textField: 'itemname' },
                { id: 'roleid', url: '/Admin/FrameworkModules/RoleAdmin/GetEnabledRoleList/', valueField: 'id', textField: 'realname' },
                { id: 'companyid', url: '/Admin/FrameworkModules/OrganizeAdmin/GetOrganizeByCategory/?organizeCategory=Company', valueField: 'id', textField: 'fullname' },
                { id: 'subcompanyid', url: '/Admin/FrameworkModules/OrganizeAdmin/GetOrganizeByCategory/?organizeCategory=SubCompany', valueField: 'id', textField: 'fullname' },
                { id: 'departmentid', url: '/Admin/FrameworkModules/OrganizeAdmin/GetOrganizeByCategory/?organizeCategory=Department', valueField: 'id', textField: 'fullname' },
                { id: 'subdepartmentid', url: '/Admin/FrameworkModules/OrganizeAdmin/GetOrganizeByCategory/?organizeCategory=SubDepartment', valueField: 'id', textField: 'fullname' },
                { id: 'workgroupid', url: '/Admin/FrameworkModules/OrganizeAdmin/GetOrganizeByCategory/?organizeCategory=Workgroup', valueField: 'id', textField: 'fullname' }
            ];

            function populateSelect(config) {
                return $.getJSON(config.url, function (res) {
                    var options = '<option value="">请选择</option>';
                    if (Array.isArray(res)) {
                        $.each(res, function (_, item) {
                            options += '<option value="' + (item[config.valueField] || '') + '">' + (item[config.textField] || '') + '</option>';
                        });
                    }
                    $('#' + config.id).html(options);
                });
            }

            var loadPromises = [];
            $.each(selectConfigs, function (_, cfg) {
                loadPromises.push(populateSelect(cfg));
            });

            var selectsLoaded = false;
            $.when.apply($, loadPromises).always(function () {
                selectsLoaded = true;
                form.render('select');
                if (window.UserForm && typeof window.UserForm.onSelectLoaded === 'function') {
                    window.UserForm.onSelectLoaded();
                }
            });

            function getSelectedText(id) {
                var elem = document.getElementById(id);
                if (!elem) {
                    return '';
                }
                var option = elem.options[elem.selectedIndex];
                return option ? option.text : '';
            }

            window.UserForm = {
                onSelectLoaded: null,
                initForAdd: function () {
                    $('#passwordRow').show();
                    $('#userpassword').val('');
                    $('#username').prop('disabled', false);
                    form.val('userForm', {
                        username: '',
                        realname: '',
                        code: '',
                        gender: '',
                        mobile: '',
                        birthday: '',
                        telephone: '',
                        duty: '',
                        qicq: '',
                        title: '',
                        email: '',
                        roleid: '',
                        homeaddress: '',
                        companyid: '',
                        subcompanyid: '',
                        departmentid: '',
                        subdepartmentid: '',
                        workgroupid: '',
                        enabled: true,
                        description: ''
                    });
                    $('#enabled').prop('checked', true);
                    form.render('select');
                    form.render('checkbox');
                },
                setFormData: function (data) {
                    this.onSelectLoaded = function () {
                        form.val('userForm', {
                            username: data.username || '',
                            realname: data.realname || '',
                            code: data.code || '',
                            gender: data.gender || '',
                            mobile: data.mobile || '',
                            birthday: data.birthday ? (data.birthday.split(' ')[0]) : '',
                            telephone: data.telephone || '',
                            duty: data.duty || '',
                            qicq: data.qicq || '',
                            title: data.title || '',
                            email: data.email || '',
                            roleid: data.roleid || '',
                            homeaddress: data.homeaddress || '',
                            companyid: data.companyid || '',
                            subcompanyid: data.subcompanyid || '',
                            departmentid: data.departmentid || '',
                            subdepartmentid: data.subdepartmentid || '',
                            workgroupid: data.workgroupid || '',
                            description: data.description || ''
                        });
                        $('#enabled').prop('checked', data.enabled === 1 || data.enabled === true);
                        form.render('select');
                        form.render('checkbox');
                    };
                    $('#passwordRow').hide();
                    $('#username').prop('disabled', data.username === 'Administrator');
                    if (selectsLoaded) {
                        this.onSelectLoaded();
                    }
                },
                getData: function () {
                    var result = form.val('userForm');
                    result.enabled = $('#enabled').prop('checked') ? 1 : 0;
                    result.companyname = getSelectedText('companyid');
                    result.subcompanyname = getSelectedText('subcompanyid');
                    result.departmentname = getSelectedText('departmentid');
                    result.subdepartmentname = getSelectedText('subdepartmentid');
                    result.workgroupname = getSelectedText('workgroupid');
                    result.rolename = getSelectedText('roleid');
                    return result;
                },
                validate: function () {
                    var data = form.val('userForm');
                    if (!data.username) {
                        layer.msg('请输入登录用户名');
                        return false;
                    }
                    if (!data.realname) {
                        layer.msg('请输入姓名');
                        return false;
                    }
                    if (!data.code) {
                        layer.msg('请输入编号');
                        return false;
                    }
                    if ($('#passwordRow').is(':visible') && !data.userpassword) {
                        layer.msg('请输入密码');
                        return false;
                    }
                    if (!data.roleid) {
                        layer.msg('请选择默认角色');
                        return false;
                    }
                    return true;
                }
            };
        });
    </script>
</body>
</html>
